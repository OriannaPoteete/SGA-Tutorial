---
title: "SGA Data Analysis Tutorial"
author: "OP & PC"
date: "5/5/22"
output:
  pdf_document: 
    latex_engine: xelatex
---


### Introduction

Welcome to the Serum Growth Assay Analysis Tutorial! In this tutorial, we will go through how to use RStudio to analyze data from a Serum Growth assay.

A Serum Growth Assay is one where your isolate is grown in media that is some percentage of serum. In this tutorial, we use a practice data set where isolates were grown in either 0% Serum (Limited Media only), 50% Serum (Limited Media + Serum), and 50% Heat-inactivated (HI) Serum (Limited Media + HI-Serum). The heat-inactivated serum was created by incubating serum at 56^o^C for 30 minutes.

Before you begin to use this tutorial, you will need to install some packages in order to perform the analysis. The accompanying README file will detail which packages and what you need to do to install them into RStudio.

# Setting Up the Knit options for RMarkdown

Before we begin the analysis using R, we need to set up the knit options. Knitting is how Rstudio will print an output file. In this tutorial, we will knit to pdf, so when you hit the knit button, which is found at the top of the RMarkdown pane (which should be at the top of this window pane), Rstudio will run all of the different code chunks and save the results in a PDF. The following code chunk will set up some options for knitting. Run this code chunk by hitting the play button at the top right corner of the chunk (next to the cog wheel).

```{r setup, include=FALSE}
knitr::opts_chunk$set(warning = FALSE, message = FALSE)
```

Let's breakdown what this code chunk does:

knitr::opts_chunk$set -- this is the function that will allow us to set some options for how RStudio will knit our RMarkdown.
warning = FALSE -- This tells Rstudio that we don't want to see any warning in the pdf when we knit.
message = FALSE -- This will prevent warning messages when knitting.
echo = FALSE -- This is not in the above code chunk, but worth mentioning. This condition will prevent RStudio from printing out the code chunks when you knit. This is a nice option to make your pdf output a little more professional.

# Loading the Appropriate Libraries
This code chunk will load the necessary libraries need for our analysis. These libraries should already be installed, but if not, please see the README file on how to do it.

Every time you open a project in RStudio, you will need to run your library code chunk, or a lot of your code chunks will just return an error instead of the results you want. Go ahead and run this code chunk.
```{r load libraries}
library(dplyr)
library(ggplot2)
library(tinytex)
library(tidyverse)
library(readxl)
library(viridis)
library(ggpubr)
library(knitr)
library(kableExtra)
```

# Preparing Data for Analysis

## Importing Data from Excel

RStudio is a great tool for analyzing your data, but it is very tedious to input that data into a usable format in RStudio. We opted to using Excel to organize our data and import it into RStudio. Run the following code chunk and select the tutorial Excel file to import the data to RStudio.

```{r read file}
# raw_data <- read_excel(file.choose(), sheet = "Sheet1")
raw_data <- read_excel("C:/Users/kopot/Desktop/Work/SGA/SGA_2290_WT_-1del_-2del_PC04202022.xlsx", sheet = "Sheet1")
raw_data
```

raw_data -- this is a name for a variable we chose to store our EXcel data. The "<-" says to store everything to the left of our variable name into that variable name. You can see what is in that variable by having a line that has just the variable name.
read_excel <- This function is part of the readxl library and will read_excel in a RStudio friendly format.
    file.choose() -- This will prompt a window that will let you choose an excel file for RStudio to load.
    sheet -- This will tell the read_excel function which sheet in Excel contains the data you want to import into RStudio. The default is "Sheet1", so we'll leave it like this for now.

## Replacing Special Characters in Column Names

While RStudio is great for analyzing data, we have to format our data to use it in RStudio. RStudio does not like having special characters in the column names and will not perform analysis. First we will identify and remove special characters from the column names in our data set.

This code chunk will store our data set into a new variable. Whenever you are formatting your data, it is recommended to store your data into a new variable and use that to perform your formatting, so that you can go back if you make a mistake. Run the following code chunk to create a new data set that we will use.

```{r, New datset}
raw_data_colnames <- raw_data
```

The following code chunk identifies the special characters by their unicode and replaces them with specified text. 

```{r, Replacing Special Characters}
delta_replace <- gsub("\u0394", "del", colnames(raw_data_colnames))
colnames(raw_data_colnames) <- delta_replace
options(dplyr.width = Inf)
raw_data_colnames
```

data_replace -- list of new column names
gsub -- creates a list with the special character replaced by the given text
    "\u0394" -- unicode for the special character
    "del" -- text that will be replacing the character
    colnames() -- the text specifies which dataset the code is changing
options -- changes with options for knitting the table
  dplyr.width = Inf -- changes the width of the table to infinity so that the whole table fits on one page
raw_data_colnames -- this just displays the changed dataset


## Averaging Blank Measurements for Removing Background Noise

```{r, second New dataset}
raw_data_blank_mean <- raw_data_colnames
```

```{r, Averaging Blanks}
raw_data_blank_mean <- raw_data_colnames %>%
  select(contains("Blank")) %>%
  colMeans(na.rm = TRUE) %>%
  round(3)
```

## Removing Blank Measurement from Table

```{r clean data}
raw_data_clean <- raw_data_colnames %>%
  select(-`0% (Blank)`, -`50% (Blank)`, -`HI-50% (Blank)`, -`Time`)
```

## Removing Background Noise



```{r for loop}
for (a in 1:ncol(raw_data_clean)) {
 if (grepl(" 0%", colnames(raw_data_clean)[a])) {
   raw_data_clean[ , a] <- raw_data_clean[ , a] - 
     as.numeric(raw_data_blank_mean[1])
 }
 if (grepl(" 50%", colnames(raw_data_clean)[a])) {
   raw_data_clean[ , a] <- raw_data_clean[ , a] - 
     as.numeric(raw_data_blank_mean[2])
 }
 if (grepl("-50%", colnames(raw_data_clean)[a])) {
   raw_data_clean[ , a] <- raw_data_clean[ , a] - 
     as.numeric(raw_data_blank_mean[3])
 }
}
```




``` {r replace}
raw_data_clean_t <- raw_data_clean

if (length(i <- grep("del", colnames(raw_data_clean_t)))) {
 delta_replace <- gsub("del", "\u0394", colnames(raw_data_clean_t))
}
if (length(i <- grep("del", colnames(raw_data_clean_t)))) {
  colnames(raw_data_clean_t) <- delta_replace
}
options(dplyr.width = Inf)
kable(raw_data_clean_t, caption = "Serum Growth Assay for GN02290", "latex", booktabs = T) %>%
  kable_styling(latex_options = c("striped", "scale_down", "hold_position"))
```

# Transforming the Data

```{r time}

trans_data <- stack(raw_data_clean) %>%
  mutate(Time = rep(c(1,2,3,4), times = 9))
colnames(trans_data) [1:2] <- c("OD", "Sample")
```


# Graphing Cleaned Data

```{r plots}
od_600 = expression(paste(OD[600]))
zero_plot <- trans_data %>%
  filter(grepl(" 0%", Sample)) %>%
  ggplot(aes(x = Time, color = Sample, y = OD))+
  geom_point(size = 1.5)+
  geom_line()+
  labs(title = "0% Serum", y = od_600)+
  theme(plot.title = element_text(hjust = 0.5), legend.title = element_blank())+
  scale_colour_manual(values = c("#c51b8a","#d95f0e","#2c7fb8"), 
                      labels = c("WT", "-1\u0394", "-2\u0394"))+
  xlim(0,4)+
  ylim(-0.1,1)

fifty_plot <- trans_data %>%
  filter(grepl(" 50%", Sample)) %>%
  ggplot(aes(x = Time, color = Sample, y = OD))+
  geom_point(size = 1.5)+
  geom_line()+
  labs(title = "50% Serum",  y = od_600)+
  theme(plot.title = element_text(hjust = 0.5), legend.title = element_blank())+
  scale_colour_manual(values = c("#c51b8a","#d95f0e","#2c7fb8"), 
                      labels = c("WT", "-1\u0394", "-2\u0394"))+
  xlim(0,4)+
  ylim(-0.1,1)

hi_plot <- trans_data %>%
  filter(grepl("HI-50%", Sample)) %>%
  ggplot(aes(x = Time, color = Sample, y = OD))+
  geom_point(size = 1.5)+
  geom_line()+
  labs(title = "HI-50% Serum", y = od_600)+
  theme(plot.title = element_text(hjust = 0.5), legend.title = element_blank())+
  scale_colour_manual(values = c("#c51b8a","#d95f0e","#2c7fb8"), 
                      labels = c("WT", "-1\u0394", "-2\u0394"))+
  xlim(0,4)+
  ylim(-0.1,1)

figure_1 <- ggarrange(zero_plot, fifty_plot, hi_plot,
                    labels = c("A", "B", "C"),
                    ncol = 2, nrow = 2, common.legend = TRUE,legend="bottom")
annotate_figure(figure_1, top = text_grob("Serum Growth Assay for GN02290", 
               color = "black", face = "bold", size = 14))
```
